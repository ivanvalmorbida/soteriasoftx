<!DOCTYPE html>

<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Cadastro de Pessoas - SoteriaSoft</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script> -->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</head>
<div id="app" style="padding: 0px 20px 0px 20px;">
    <h4 class="text-bg-info p-3 bi-people-fill"> Cadastro de Pessoas</h4>
    <br>

    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pills-principal-tab" data-bs-toggle="pill"
                data-bs-target="#pills-principal" type="button" role="tab" aria-controls="pills-principal"
                aria-selected="true">Principal</button>
        </li>

        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pills-contatos-tab" data-bs-toggle="pill" data-bs-target="#pills-contatos"
                type="button" role="tab" aria-controls="pills-contatos" aria-selected="false">Contatos</button>
        </li>

        <li v-if="pessoa.tipo=='F'" class="nav-item" role="presentation">
            <button class="nav-link" id="pills-fisica-tab" data-bs-toggle="pill" data-bs-target="#pills-fisica"
                type="button" role="tab" aria-controls="pills-fisica" aria-selected="false">Física</button>
        </li>

        <li v-if="pessoa.tipo=='J'" class="nav-item" role="presentation">
            <button class="nav-link" id="pills-juridica-tab" data-bs-toggle="pill" data-bs-target="#pills-juridica"
                type="button" role="tab" aria-controls="pills-juridica" aria-selected="false">Jurídica</button>
        </li>
    </ul>
    <div class="tab-content" id="pills-tabContent">
        <div class="tab-pane fade show active" id="pills-principal" role="tabpanel"
            aria-labelledby="pills-principal-tab" tabindex="0">
            <div class="row g-3">
                <div class="col-md-9">
                    <label for="txtnome" class="form-label-sm">Nome</label>
                    <input id="txtnome" class="form-control form-control-sm" type="text" v-model="pessoa.nome" />
                </div>

                <div class="col-md-3">
                    <fieldset>
                        <legend style="font-size:16px;">Tipo de pessoa</legend>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" name="rad_tipo" type="radio" id="rad_tipoF" value="F"
                                v-model="pessoa.tipo">
                            <label class="form-check-label" for="rad_tipoF">Física</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" name="rad_tipo" type="radio" id="rad_tipoJ" value="J"
                                v-model="pessoa.tipo">
                            <label class="form-check-label" for="rad_tipoJ">Jurídica</label>
                        </div>
                    </fieldset>
                </div>

                <div class="col-md-3">
                    <label for="txtcep" class="form-label-sm">CEP</label>
                    <input id="txtcep" type="text" v-model="pessoa.cep" class="form-control form-control-sm"
                        @change="buscar_cep()" />
                </div>

                <div class="col-md-2">
                    <label for="txtuf" class="form-label-sm">UF</label>
                    <select id="txtuf" class="form-select form-select-sm" v-model="pessoa.uf">
                        <option v-for="u in ufs" :value="u.codigo">{{u.sigla}}</option>
                    </select>
                </div>

                <div class="col-md-7">
                    <label for="txtcidade" class="form-label-sm">Cidade</label>
                    <input @change="cidade_change()" v-model="pessoa.cidade" id="txtcidade"
                        class="form-control form-control-sm" list="dtlcidade"
                        placeholder="Insira as iniciais e pressione Enter">
                    <datalist id="dtlcidade">
                        <option v-for="c in cidades" :key="c.codigo">{{c.nome}}</option>
                    </datalist>
                </div>

                <div class="col-md-5">
                    <label for="txtbairro" class="form-label-sm">Bairro</label>
                    <input @change="bairro_change()" v-model="pessoa.bairro" id="txtbairro"
                        class="form-control form-control-sm" list="dtlbairro"
                        placeholder="Insira as iniciais e pressione Enter" f>
                    <datalist id="dtlbairro">
                        <option v-for="c in bairros" :key="c.codigo">{{c.nome}}</option>
                    </datalist>
                </div>

                <div class="col-md-7">
                    <label for="txtendereco" class="form-label-sm">Endereço</label>
                    <input @change="endereco_change()" v-model="pessoa.endereco" id="txtendereco"
                        class="form-control form-control-sm" list="dtlendereco"
                        placeholder="Insira as iniciais e pressione Enter">
                    <datalist id="dtlendereco">
                        <option v-for="c in enderecos" :key="c.codigo">{{c.nome}}</option>
                    </datalist>
                </div>

                <div class="col-md-4">
                    <label for="txtnumero" class="form-label-sm">Número predial</label>
                    <input id="txtnumero" class="form-control form-control-sm" type="text" v-model="pessoa.numero" />
                </div>

                <div class="col-md-8">
                    <label for="txtcomplemento" class="form-label-sm">Complemento</label>
                    <input id="txtcomplemento" class="form-control form-control-sm" type="text"
                        v-model="pessoa.complemento" />
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-contato" role="tabpanel" aria-labelledby="pills-contato-tab" tabindex="0">
        </div>

        <div class="tab-pane fade" id="pills-fisica" role="tabpanel" aria-labelledby="pills-fisica-tab" tabindex="0">
            <div class="row g-3">
                <div class="col-md-3">
                    <fieldset>
                        <legend style="font-size:16px;">Sexo</legend>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="rad_sexo" id="rad_sexoF" value="F"
                                v-model="pessoa.sexo">
                            <label class="form-check-label" for="rad_sexoF">Feminino</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="rad_sexo" id="rad_sexoM" value="M"
                                v-model="pessoa.sexo">
                            <label class="form-check-label" for="rad_sexoM">Masculino</label>
                        </div>
                    </fieldset>
                </div>

                <div class="col-md-3">
                    <label for="txtnascimento" class="form-label-sm">Nascimento</label>
                    <input id="txtnascimento" class="form-control form-control-sm" type="date"
                        v-model="pessoa.nascimento" />
                </div>

                <div class="col-md-6">
                    <label for="txtnacionalidade" class="form-label-sm">Nascionalidade</label>
                    <input @change="nacionalidade_change()" v-model="pessoa.nacionalidade" id="txtnacionalidade"
                        class="form-control form-control-sm" list="dtlnacionalidade"
                        placeholder="Insira as iniciais e pressione Enter">
                    <datalist id="dtlnacionalidade">
                        <option v-for="c in nacionalidades" :key="c.codigo">{{c.pais}}</option>
                    </datalist>
                </div>

                <div class="col-md-2">
                    <label for="txtuf" class="form-label-sm">UF Nascimento</label>
                    <select id="txtuf" class="form-select form-select-sm" v-model="pessoa.uf">
                        <option v-for="u in ufs" :value="u.codigo">{{u.sigla}}</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label for="txtcidade_nasc" class="form-label-sm">Cidade Nascimento</label>
                    <input @change="cidade_change()" v-model="pessoa.cidadenasc" id="txtcidade_nasc"
                        class="form-control form-control-sm" list="dtlcidade"
                        placeholder="Insira as iniciais e pressione Enter">
                    <datalist id="dtlcidade">
                        <option v-for="c in cidades" :key="c.codigo">{{c.nome}}</option>
                    </datalist>
                </div>

                <div class="col-md-4">
                    <label for="txtcpf" class="form-label-sm">CPF</label>
                    <input id="txtcpf" class="form-control form-control-sm" type="text" v-model="pessoa.cpf" />
                </div>

                <div class="col-md-5">
                    <label for="cmpestadocivil" class="form-label-sm">Estado civil</label>
                    <select class="form-select form-select-sm" id="cmbestadocivil">
                        <option v-for="e in estadocivils" :value="e.codigo">{{e.descricao}}</option>
                    </select>
                </div>

                <div class="col-md-7">
                    <label for="txtconjuge" class="form-label-sm">Conjuge</label>
                    <input @change="conjuge_change()" v-model="pessoa.conjuge" id="txtconjuge"
                        class="form-control form-control-sm" list="dtlconjuge"
                        placeholder="Insira as iniciais e pressione Enter">
                    <datalist id="dtlconjuge">
                        <option v-for="c in conjuges" :key="c.codigo">{{c.nome}}</option>
                    </datalist>
                </div>

                <div class="col-md-7">
                    <label for="txtprofissao" class="form-label-sm">Profissão</label>
                    <input @change="profissao_change()" v-model="pessoa.profissao" id="txtprofissao"
                        class="form-control form-control-sm" list="dtlprofissao"
                        placeholder="Insira as iniciais e pressione Enter">
                    <datalist id="dtlprofissao">
                        <option v-for="c in profissoes" :key="c.cbo">{{c.descricao}}</option>
                    </datalist>
                </div>
            </div>

        </div>

        <!-- Juridica -->
        <div class="tab-pane fade" id="pills-juridica" role="tabpanel" aria-labelledby="pills-juridica-tab"
            tabindex="0">
            <div class="row g-3">
                <div class="col-md-9">
                    <label for="txtnome" class="form-label-sm">Razão Social</label>
                    <input id="txtnome" class="form-control form-control-sm" type="text" v-model="pessoa.razao" />
                </div>

                <div class="col-md-3">
                    <label for="txtnome" class="form-label-sm">CNPJ</label>
                    <input id="txtnome" class="form-control form-control-sm" type="text" v-model="pessoa.cnpj" />
                </div>

                <div class="col-md-5">
                    <label for="txtatividade" class="form-label-sm">Atividade</label>
                    <input @change="atividade_change()" v-model="pessoa.atividade" id="txtatividade"
                        class="form-control form-control-sm" list="dtlatividade"
                        placeholder="Insira as iniciais e pressione Enter">
                    <datalist id="dtlatividade">
                        <option v-for="a in atividades" :key="c.codigo">{{a.descricao}}</option>
                    </datalist>
                </div>

                <div class="col-md-7">
                    <label for="txtrepresentante" class="form-label-sm">Representante</label>
                    <input @change="representante_change()" v-model="pessoa.representante" id="txtrepresentante"
                        class="form-control form-control-sm" list="dtlrepresentante"
                        placeholder="Insira as iniciais e pressione Enter">
                    <datalist id="dtlrepresentante">
                        <option v-for="c in representantes" :key="c.codigo">{{c.nome}}</option>
                    </datalist>
                </div>
            </div>
        </div>
    </div>
</div>

<br>

<div class="text-bg-secondary p-3">
    <button type="button" class="btn btn-primary bi-file-earmark-plus" @click="limpar(true)"> Novo</button>
    <button :disabled="!boosalvar" style="margin-left: 20px;" type="button" class="btn btn-success bi-save"
        @click="gravar()">
        Gravar</button>
    <button style="margin-left: 20px;" type="button" class="btn btn-danger bi-trash" @click="apagar()">
        Apagar</button>
    <button style="margin-left: 20px;" type="button" class="btn btn-light bi-search" @click="pesquisa()">
        Localizar</button>
</div>

<div id="modSalvar" class="modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" style="color: #008000;">Salvar dados</h5>
                <a class="btn-close" href="#" rel="modal:close"></a>
            </div>
            <div class="modal-body">
                <p style="color: #ffa500;">{{msginfo}}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="$('#modSalvar').hide()">Ok</button>
            </div>
        </div>
    </div>
</div>
</div>

<script src="js/jmask_1.14.16.min.js"></script>
<script src="js/jmodal_0.9.1.min.js"></script>
<script src="js/vue_2.6.14.min.js"></script>
<script src="js/vue-resource_1.5.3.min.js"></script>

<script type="module">
    var vm = new Vue({
        el: '#app',
        data: function data() {
            return {
                pessoa: {
                    nome: '',
                    cep: '',
                    uf: 0,
                    cidade: '',
                    bairro: '',
                    endereco: '',
                    tipo: '',
                    sexo: '',
                    nascimento: '00:00:00'
                },
                conjuges: [],
                profissoes: [],
                nacionalidades: [],
                estadocivils: [],
                atividades: [],
                representantes:[],
                nome: '',
                lstcep: [],
                msginfo: '',
                cep: '',

                uf: null,
                ufs: [],

                cidade: '',
                cidades: [],

                bairro: '',
                bairros: [],

                endereco: '',
                enderecos: [],

                complemento: '',

                boosalvar: true
            };
        },

        methods: {
            profissao_change() {
                if (this.pessoa.profissao != null) {
                    if (this.pessoa.profissao.length > 2) {
                        this.$http.post("/cbo/cbo_descricao", { str: this.pessoa.profissao }).then((res) => {
                            var r = res.body
                            this.profissoes = r
                        })
                    }
                }
            },

            nacionalidade_change() {
                if (this.pessoa.nacionalidade != null) {
                    if (this.pessoa.nacionalidade.length > 2) {
                        this.$http.post("/nacionalidade/nacionalidade_pais", { str: this.pessoa.nacionalidade }).then((res) => {
                            var r = res.body
                            this.nacionalidades = r
                        })
                    }
                }
            },

            cidade_change() {
                if (this.pessoa.cidade != null) {
                    if (this.pessoa.cidade.length > 2) {
                        this.$http.post("/cidade/nome", { str: this.pessoa.cidade }).then((res) => {
                            var r = res.body
                            this.cidades = r
                        })
                    }
                }
            },

            bairro_change() {
                if (this.bairro != null) {
                    if (this.bairro.length > 2) {
                        this.$http.post("/bairro/nome", { str: this.pessoa.bairro }).then((res) => {
                            var r = res.body
                            this.bairros = r
                        })
                    }
                }
            },

            endereco_change() {
                if (this.endereco != null) {
                    if (this.endereco.length > 2) {
                        this.$http.post("/endereco/nome", { str: this.pessoa.endereco }).then((res) => {
                            var r = res.body
                            this.enderecos = r
                        })
                    }
                }
            },

            pesquisa() {
                if (this.uf != null) {
                    this.$http.post('/cep/pesquisa', { estado: this.uf, cidade: this.cidade, bairro: this.bairro }).then((res) => {
                        if (res.body.length > 0) {
                            console.dir(res.body)
                            this.lstcep = res.body
                        }
                        else {
                            this.lstcep = []
                        }
                    })
                }
            },

            mostrarcep(v) {
                this.cep = v
                this.buscar_cep()
            },

            buscar_cep() {
                var c = this.pessoa.cep
                c = c.replace('.', '')
                c = c.replace('-', '')

                if (c.length == 8) {
                    this.$http.post('/cep/cep', { cep: c }).then((res) => {
                        if (res.body.length > 0) {
                            this.uf = res.body[0].estado
                            this.cidade = res.body[0].cidade_
                            this.bairro = res.body[0].bairro_
                            this.endereco = res.body[0].endereco_
                            this.complemento = res.body[0].complemento
                        }
                        else {
                            this.limpar(false)
                        }
                    })
                }
            },

            limpar(l) {
                if (l) this.cep = ''
                this.complemento = ''
                this.uf = null
                this.cidade = ''
                this.bairro = ''
                this.endereco = ''
            },

            gravar() {
                if (this.uf == null) {
                    this.msginfo = 'Selecione a unidade federativa!'
                    $("#modSalvar").modal({})

                } else {
                    if (this.cidade == '') {
                        this.msginfo = 'Selecione a cidade!'
                        $("#modSalvar").modal({})

                    } else {
                        if (this.cep == '') {
                            this.msginfo = 'CEP não informado!'
                            $("#modSalvar").modal({})

                        } else {
                            this.boosalvar = false
                            this.$http.post('/cep/gravar', {
                                cep: this.cep, estado: this.uf, cidade: this.cidade,
                                bairro: this.bairro, endereco: this.endereco, complemento: this.complemento
                            }).then((res) => {
                                if (res.data.err_msg == '')
                                    this.limpar(true)
                                else
                                    alert('Houve um erro ao salvar: ' + res.err_msg)

                                this.boosalvar = true
                            })
                        }
                    }
                }
            },

            apagar() {
                var c = this.cep
                c = c.replace('.', '')
                c = c.replace('-', '')

                if (c.length == 8) {
                    if (confirm("Confirma a exclusão desse CEP?")) {
                        this.$http.post('/cep/apagar', { cep: c }).then((res) => {
                            if (res.data.err_msg == '')
                                this.limpar(true)
                            else
                                alert('Houve um erro ao apagar: ' + res.err_msg)
                        })
                    }
                }
            },

            buscaCep: function () {
                if (this.cep != '') {
                    var r = `https://viacep.com.br/ws/${this.cep.replace('.', '').replace('-', '')}/json/`

                    fetch(r).then(response => response.json()).then(cep => {
                        if (cep.erro)
                            alert("Houve um erro ao tentar obter informações desse CEP!")
                        else {
                            console.dir(cep)
                            this.$http.post("/estado/sigla", { str: cep.uf }).then((res) => {
                                this.uf = res.body.codigo
                                this.cidade = cep.localidade
                                this.bairro = cep.bairro
                                this.endereco = cep.logradouro
                                this.complemento = cep.complemento
                            })
                        }
                    })
                }
            }
        },

        created: function () {
            this.$http.post("/estado/todos").then((res) => {
                this.ufs = res.body
            })

            this.$http.post("/estado_civil/estado_civil_todos").then((res) => {
                this.estadocivils = res.body
                this.estadocivils.unshift({ codigo: 0, descricao: '' })
            })

            //this.$http.post("https://mielina.com.br/ws_Site/site.asmx/uf_todas").then((res) => {
            // this.$http.post("http://172.16.172.199/mielinax/ws/uf.asmx/carregar").then((res) => {
            //     console.log(res.data.d)
            // })

            var regex = /[?&]([^=#]+)=([^&#]*)/g, url = window.location.href, params = {}, match
            while (match = regex.exec(url)) {
                params[match[1]] = match[2]
            }

            if (params.pe != undefined) {
                this.codigo = params.pe
                this.buscar_cep()
            }
        }
    });
</script>

</html>